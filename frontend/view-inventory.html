<div class="page-view-inventory">
    <div class="page-header">
        <h1>Inventory Items</h1>
    </div>
    
    <div class="inventory-stats">
        <div class="stat-card">
            <h3>Total Items</h3>
            <p id="totalItems">0</p>
        </div>
        <div class="stat-card">
            <h3>Items Expiring Soon</h3>
            <p id="expiringItems">0</p>
        </div>
        <div class="stat-card">
            <h3>Expired Items</h3>
            <p id="expiredItems">0</p>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="inventory-table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Quantity</th>
                    <th>Purchase Date</th>
                    <th>Purchase Price</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody">
                <tr>
                    <td colspan="7" class="no-data">Loading inventory...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
});

async function loadInventory() {
    try {
        const response = await fetch('/api/inventory');
        const data = await response.json();
        const inventory = Array.isArray(data) ? data : (data.data || []);
        displayInventory(inventory);
        calculateInventoryStats(inventory);
    } catch (error) {
        console.error('Error loading inventory:', error);
        document.getElementById('inventoryTableBody').innerHTML = '<tr><td colspan="7" class="no-data">Error loading inventory</td></tr>';
    }
}

function displayInventory(inventory) {
    const tbody = document.getElementById('inventoryTableBody');
    if (!inventory || inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No inventory items found</td></tr>';
        return;
    }
    
    tbody.innerHTML = inventory.map(item => {
        const expiryDate = item.hasNoExpiry ? 'No Expiry' : new Date(item.expiryDate).toLocaleDateString();
        const status = getItemStatus(item);
        
        return `
            <tr>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>${new Date(item.purchaseDate).toLocaleDateString()}</td>
                <td>PKR ${item.purchasePrice.toFixed(2)}</td>
                <td>${expiryDate}</td>
                <td><span class="status ${status.toLowerCase()}">${status}</span></td>
                <td>
                    <button class="btn btn-secondary" onclick="editInventory('${item._id}')">Edit</button>
                    <button class="btn btn-danger" onclick="deleteInventory('${item._id}')">Delete</button>
                </td>
            </tr>
        `;
    }).join('');
}

function getItemStatus(item) {
    if (item.hasNoExpiry) return 'No Expiry';
    
    const today = new Date();
    const expiryDate = new Date(item.expiryDate);
    const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
    
    if (daysUntilExpiry < 0) return 'Expired';
    if (daysUntilExpiry <= 7) return 'Expiring Soon';
    return 'Active';
}

function calculateInventoryStats(inventory) {
    const today = new Date();
    const expired = inventory.filter(item => 
        !item.hasNoExpiry && new Date(item.expiryDate) < today
    ).length;
    
    const expiringSoon = inventory.filter(item => 
        !item.hasNoExpiry && {
            const expiryDate = new Date(item.expiryDate);
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            return daysUntilExpiry > 0 && daysUntilExpiry <= 7;
        }
    ).length;
    
    document.getElementById('totalItems').textContent = inventory.length;
    document.getElementById('expiredItems').textContent = expired;
    document.getElementById('expiringItems').textContent = expiringSoon;
}

function editInventory(id) {
    alert('Edit inventory: ' + id);
}

function deleteInventory(id) {
    if (confirm('Are you sure you want to delete this inventory item?')) {
        alert('Delete inventory: ' + id);
    }
}
</script>
